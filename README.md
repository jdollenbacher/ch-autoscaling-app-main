# CH Autoscaling

## Introduction

This custom auto scaling application is implemented using CloudHub platform APIs and can be used to achieve horizontal scaling (increases or decrease the number of workers) of applications deployed to CloudHub. It uses the CPU and Memory utilization alerts triggered by Anypoint Runtime Manager as events to perform auto scaling.  

## High Level Architecture 

 ![image](https://user-images.githubusercontent.com/53312061/116472071-06780d80-a83b-11eb-8ce3-826758d0a565.png)

 This application is designed to run as a standalone application and must be supplied with the details of each CH API/application (for which the auto scaling is desired) inside the properties file.
It uses CloudHub platform APIs for interaction with CloudHub to read triggered alert details, existing application worker configuration and scaling of the workers. 

The framework application can be triggered in following ways and will perform the auto scaling based on the rules configured:

1.	IMAP events: The application will poll for the email notifications generated by runtime manager alerts
2.	Scheduled check: The application will run at the scheduled intervals and will read the alerts generated by runtime manager. If there were any alerts history found within in the time interval specified, the application will further proceed with auto scaling

The application will perform scale in/out only if there are consecutive runtime manager alerts of the same type and when the alert count matches with the scale in/out count specified in the properties file.


## Usage

Following are the pre-requisites required for the functioning of this application:
  - Additional vCoress should be available for the scaling up of the CH applications
  - CPU and Memory utilization alerts are configured in the runtime manager and
  - Local user with following permissions:
      - Read Alerts
      - Read Applications
      - Manage Settings

Refer to following steps for using the auto-scaling application described in this article:

1.	Add the Runtime Manager alerts for CPU and/or memory consumption for desired high and low threshold values. These alert configurations are critical since the auto-scaling application uses these alerts as triggers for performing scaling of the CH application workers.
2.	Download the application from Github and deploy to your CH account. Deploy 1 instance of this application in each environment where you want to implement the auto scaling functionality.
3.	Update the property file (config.yaml) to include the application details for which the auto scaling is to be enabled. Refer to following for configuration details: 
    -	alerts.id: alert Ids from the Runtime Manager alerts created in step 1. 
    -	email: connection details for the email server if IMAP email polling is used
    -	auto-scaling.apps: The comma separated list of applications (CH application names) which requires auto-scaling to be enabled 
    - aut-scaling.alert-time-interval: Update the scheduler intervals based on the time interval setting in alert configuration so that this application can be triggered to perform the checks in sync with generation of the alerts. Note: in case of scheduler-based execution, the time interval configuration is also used to consider the alerts generated within this time frame. For e.g. if the alert time interval is set to 10, the application will only check for the alerts generated in last 10 mins.
    - Individual application name along with scaling criteria mentioned below.
       -	min-worker-count:  Minimum number of CH workers required by the application
       -	cpu.utilization.scale-up-count: Number of consecutive high CPU utilization alerts required for scale up
       - cpu.utilization.scale-down-count: Number of consecutive low CPU utilization alerts required for scale down
       -	memory.utilization.scale-up-count: Number of consecutive high Memory utilization alerts required for scale up
       - memory.utilization.scale-up-count: Number of consecutive high Memory utilization alerts required for scale down
    - CH related configurations such as username, password and environment Id in which the application is running
    - Object store configuration for managing time to live for keys. The application uses Object Store to maintain the alert count to perform scaling in/out. Update the entry time to live configuration (using os.ttl property) for Object Store to reset the application alert count so that application state gets refreshed.

## Important notes

1.	Auto scaling feature is also available as part of Anypoint platform for ELA customers. It's highly recommended to discuss this with MuleSoft EM/AE before using this solution for any customer.
2.	The solution is based on CH platform APIs; therefore, the solution might require updates/changes if any of the platform APIs change over time. Any future limitations or stability of platform APIs could impact the functionality of this application. 
3.	This solution is a custom solution, and no special support would be provided by the MuleSoft support team.


